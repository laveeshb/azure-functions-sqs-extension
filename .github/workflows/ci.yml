name: CI

on:
  pull_request:
    types: [labeled]

jobs:
  build:
    if: contains(github.event.pull_request.labels.*.name, 'ready-to-merge')
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        dotnet-version: ['6.0.x', '8.0.x']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    
    - name: Restore dependencies
      run: |
        dotnet restore dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj
        dotnet restore dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj
        dotnet restore dotnet/test/Extensions.SQS.Test.InProcess/Extensions.SQS.Test.InProcess.csproj
        dotnet restore dotnet/test/Extensions.SQS.Test.Isolated/Extensions.SQS.Test.Isolated.csproj
    
    - name: Build In-Process SDK
      run: dotnet build dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj --configuration Release --no-restore
    
    - name: Build Isolated Worker SDK
      run: dotnet build dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj --configuration Release --no-restore
    
    - name: Build Test - In-Process
      run: dotnet build dotnet/test/Extensions.SQS.Test.InProcess/Extensions.SQS.Test.InProcess.csproj --configuration Release --no-restore
    
    - name: Build Test - Isolated Worker
      run: dotnet build dotnet/test/Extensions.SQS.Test.Isolated/Extensions.SQS.Test.Isolated.csproj --configuration Release --no-restore
    
    - name: Pack In-Process SDK
      if: matrix.dotnet-version == '8.0.x'
      run: dotnet pack dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj --configuration Release --no-build --output ./packages
    
    - name: Pack Isolated Worker SDK
      if: matrix.dotnet-version == '8.0.x'
      run: dotnet pack dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj --configuration Release --no-build --output ./packages
    
    - name: Upload NuGet packages
      if: matrix.dotnet-version == '8.0.x'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ matrix.dotnet-version }}
        path: ./packages/*.nupkg
        retention-days: 7
    
    - name: Build Summary
      if: matrix.dotnet-version == '8.0.x'
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **In-Process SDK**: Azure.WebJobs.Extensions.SQS built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Isolated Worker SDK**: Azure.Functions.Worker.Extensions.SQS built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### NuGet Packages" >> $GITHUB_STEP_SUMMARY
        ls -lh ./packages/*.nupkg | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY

  localstack-test:
    if: contains(github.event.pull_request.labels.*.name, 'ready-to-merge')
    runs-on: ubuntu-latest
    needs: build
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: sqs
          DEBUG: 0
          DATA_DIR: /tmp/localstack/data
          AWS_DEFAULT_REGION: us-east-1
          EDGE_PORT: 4566
        options: >-
          --health-cmd "awslocal sqs list-queues || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip -q awscliv2.zip
        sudo ./aws/install --update
        aws --version
    
    - name: Wait for LocalStack
      run: |
        echo "Waiting for LocalStack to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:4566/_localstack/health | grep -q '"sqs": "available"'; then
            echo "LocalStack is ready!"
            break
          fi
          echo "Attempt $i/30: LocalStack not ready yet..."
          sleep 2
        done
    
    - name: Create SQS Test Queues
      run: |
        echo "Creating test queues..."
        aws --endpoint-url=http://localhost:4566 sqs create-queue --queue-name test-queue --region us-east-1
        aws --endpoint-url=http://localhost:4566 sqs create-queue --queue-name test-output-queue --region us-east-1
        
        echo "Listing queues..."
        aws --endpoint-url=http://localhost:4566 sqs list-queues --region us-east-1
    
    - name: Send Test Message
      id: send-message
      run: |
        QUEUE_URL=$(aws --endpoint-url=http://localhost:4566 sqs get-queue-url --queue-name test-queue --region us-east-1 --output text)
        echo "Queue URL: $QUEUE_URL"
        
        MESSAGE_ID=$(aws --endpoint-url=http://localhost:4566 sqs send-message \
          --queue-url $QUEUE_URL \
          --message-body '{"test": "message", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' \
          --region us-east-1 \
          --output text \
          --query 'MessageId')
        
        echo "Message sent with ID: $MESSAGE_ID"
        echo "message_id=$MESSAGE_ID" >> $GITHUB_OUTPUT
    
    - name: Verify Message in Queue
      run: |
        QUEUE_URL=$(aws --endpoint-url=http://localhost:4566 sqs get-queue-url --queue-name test-queue --region us-east-1 --output text)
        
        MESSAGES=$(aws --endpoint-url=http://localhost:4566 sqs receive-message \
          --queue-url $QUEUE_URL \
          --max-number-of-messages 1 \
          --region us-east-1 \
          --output json)
        
        echo "Received messages:"
        echo "$MESSAGES" | jq '.'
        
        MESSAGE_COUNT=$(echo "$MESSAGES" | jq '.Messages | length')
        if [ "$MESSAGE_COUNT" -eq 0 ]; then
          echo "âŒ No messages found in queue"
          exit 1
        fi
        
        echo "âœ… Message successfully received from queue"
    
    - name: Test Summary
      if: always()
      run: |
        echo "## LocalStack Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Steps" >> $GITHUB_STEP_SUMMARY
        echo "âœ… LocalStack service started" >> $GITHUB_STEP_SUMMARY
        echo "âœ… SQS queues created" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Test message sent (ID: ${{ steps.send-message.outputs.message_id }})" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Message successfully retrieved from queue" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **All LocalStack integration tests passed!**" >> $GITHUB_STEP_SUMMARY
