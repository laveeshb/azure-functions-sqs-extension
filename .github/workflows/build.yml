name: Build

on:
  push:
    branches: [main]
    paths:
      - 'dotnet/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'dotnet/**'
      - '.github/workflows/build.yml'

jobs:
  build:
    if: "!contains(github.event.pull_request.labels.*.name, 'ready-to-merge')"
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        dotnet-version: ['6.0.x', '8.0.x']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    
    - name: Restore dependencies
      run: |
        dotnet restore dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj
        dotnet restore dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj
        dotnet restore dotnet/test/Extensions.SQS.Test.InProcess/Extensions.SQS.Test.InProcess.csproj
        dotnet restore dotnet/test/Extensions.SQS.Test.Isolated/Extensions.SQS.Test.Isolated.csproj
    
    - name: Build In-Process SDK
      run: dotnet build dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj --configuration Release --no-restore
    
    - name: Build Isolated Worker SDK
      run: dotnet build dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj --configuration Release --no-restore
    
    - name: Build Test - In-Process
      run: dotnet build dotnet/test/Extensions.SQS.Test.InProcess/Extensions.SQS.Test.InProcess.csproj --configuration Release --no-restore
    
    - name: Build Test - Isolated Worker
      run: dotnet build dotnet/test/Extensions.SQS.Test.Isolated/Extensions.SQS.Test.Isolated.csproj --configuration Release --no-restore
    
    - name: Pack In-Process SDK
      if: matrix.dotnet-version == '8.0.x'
      run: dotnet pack dotnet/src/Azure.WebJobs.Extensions.SQS/Azure.WebJobs.Extensions.SQS.csproj --configuration Release --no-build --output ./packages
    
    - name: Pack Isolated Worker SDK
      if: matrix.dotnet-version == '8.0.x'
      run: dotnet pack dotnet/src/Azure.Functions.Worker.Extensions.SQS/Azure.Functions.Worker.Extensions.SQS.csproj --configuration Release --no-build --output ./packages
    
    - name: Upload NuGet packages
      if: matrix.dotnet-version == '8.0.x'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ matrix.dotnet-version }}
        path: ./packages/*.nupkg
        retention-days: 7
    
    - name: Build Summary
      if: matrix.dotnet-version == '8.0.x'
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **In-Process SDK**: Azure.WebJobs.Extensions.SQS built successfully" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Isolated Worker SDK**: Azure.Functions.Worker.Extensions.SQS built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### NuGet Packages" >> $GITHUB_STEP_SUMMARY
        ls -lh ./packages/*.nupkg | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
